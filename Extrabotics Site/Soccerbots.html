<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Results - Extrabotics</title>
<link rel="stylesheet" href="styles.css">

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.3.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>
</head>
<body>
<!-- Floating Tech Elements -->
<div class="floating-elements">
  <div class="tech-particle" style="top: 20%; left: 10%; animation-delay: 0s;">‚öôÔ∏è</div>
  <div class="tech-particle" style="top: 60%; right: 15%; animation-delay: 2s;">üîß</div>
  <div class="tech-particle" style="top: 40%; left: 80%; animation-delay: 4s;">üíæ</div>
  <div class="tech-particle" style="top: 80%; left: 20%; animation-delay: 1s;">üñ•Ô∏è</div>
  <div class="tech-particle" style="top: 30%; right: 5%; animation-delay: 3s;">üìä</div>
  <div class="tech-particle" style="top: 70%; right: 25%; animation-delay: 5s;">üî¨</div>
</div>

<!-- Matrix Background -->
<div class="matrix-bg">
  <canvas id="matrix-canvas"></canvas>
</div>

<!-- Navigation -->
<nav class="navbar">
  <div class="nav-container">
    <a href="#" class="logo glitch-effect">Extrabotics</a>
    <ul class="nav-menu">
      <li><a href="index.html" class="nav-link">Home</a></li>
      <li><a href="about.html" class="nav-link">About</a></li>
      <li><a href="events.html" class="nav-link">Events</a></li>
      <li><a href="gallery.html" class="nav-link">Gallery</a></li>
      <li><a href="results.html" class="nav-link active">Results</a></li>
      <li><a href="contact.html" class="nav-link">Contact Us</a></li>
    </ul>
  </div>
</nav>

<!-- About Hero Section -->
<section class="about-hero">
  <div class="container">
    <h1 class="fade-in-up">Robofootball</h1>
    <p class="fade-in-up" style="animation-delay: 0.3s;">
      Track our real-time performance in the ongoing competitions Robo-Football.
    </p>
  </div>
</section>

<main class="container2">
<div id="timer-box" class="timer-display">05:00</div>
<div id="live-match-box" class="live-match-display">Loading live match...</div>
<div id="user-info" class="user-info"></div>

<!-- Login Form -->
<div id="login-form" class="login-form">
  <h3>Referee Login</h3>
  <input id="email" type="email" placeholder="Email" />
  <input id="password" type="password" placeholder="Password" />
  <button onclick="login()">Log In</button>
</div>

<!-- Team Registration -->
<div id="team-registration" class="match-editor" style="display:none;">
  <h3>Team Registration</h3>
  <input id="new-team" type="text" placeholder="Enter team name" />
  <button onclick="addTeam()">Add Team</button>
  <ul id="teams-list"></ul>
</div>

<!-- Fixture Generation -->
<div id="fixture-generator" class="match-editor" style="display:none;">
  <h3>Generate Fixtures</h3>
  <label for="matchType">Match Type:</label>
  <select id="matchType">
    <option value="1v1">1v1</option>
    <option value="2v2">2v2</option>
    <option value="3v3">3v3</option>
  </select>
  <button onclick="generateFixtures()">Generate Fixtures</button>
  <button onclick="clearFixtures()">Clear All Fixtures ‚ùå</button>


  <h4>Fixture List</h4>
  <ul id="fixtures-list"></ul>
</div>

<!-- Current Match Editor -->
<div id="match-editor" class="match-editor" style="display:none;">
  <h3>Match Management</h3>
  <div class="input-group">
    <label for="teamA">Team A Name:</label>
    <input id="teamA" type="text" placeholder="Team A name" disabled />
  </div>
  <div class="input-group">
    <label for="scoreA">Team A Score:</label>
    <input id="scoreA" type="number" min="0" placeholder="Score" disabled />
  </div>
  <div class="input-group">
    <label for="teamB">Team B Name:</label>
    <input id="teamB" type="text" placeholder="Team B name" disabled />
  </div>
  <div class="input-group">
    <label for="scoreB">Team B Score:</label>
    <input id="scoreB" type="number" min="0" placeholder="Score" disabled />
  </div>

  <div class="button-group">
    <button onclick="saveResult()" class="btn-primary">Save Live Result</button>
    <button onclick="endGame()" class="btn-primary">End Game ‚úÖ</button>
    <button onclick="clearCurrentMatch()" class="btn-secondary">Clear Current Match</button>
  </div>

  <div class="timer-controls">
    <h4>Match Timer</h4>
    <div class="button-group">
      <button onclick="startTimer()" class="btn-primary">Start Timer</button>
      <button onclick="pauseTimer()" class="btn-secondary">Pause Timer</button>
      <button onclick="resetTimer()" class="btn-secondary">Reset Timer</button>
    </div>
  </div>
</div>

<!-- Final Results Section -->
<section id="final-results" class="results-section">
  <div class="container">
    <h2>Final Results</h2>
    <table id="results-table" border="1" cellpadding="10">
      <thead>
        <tr>
          <th>Match</th>
          <th>Team A</th>
          <th>Score</th>
          <th>Team B</th>
          <th>Score</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="results-body">
      </tbody>
    </table>
  </div>
</section>

</main>



<script>
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const timerBox = () => document.getElementById('timer-box');
  const liveMatchBox = () => document.getElementById('live-match-box');
  const loginForm = () => document.getElementById('login-form');
  const matchEditorDiv = () => document.getElementById('match-editor');
  const userInfo = () => document.getElementById('user-info');
  const teamAInput = () => document.getElementById('teamA');
  const teamBInput = () => document.getElementById('teamB');
  const scoreAInput = () => document.getElementById('scoreA');
  const scoreBInput = () => document.getElementById('scoreB');
  const teamsList = document.getElementById('teams-list');
  const fixturesList = document.getElementById('fixtures-list');
  const matchTypeSelect = document.getElementById('matchType');

  const TIMER_DURATION = 300;

  const currentMatchDoc = db.collection('settings').doc('currentMatch');
  const timerDoc = db.collection('settings').doc('matchTimer');
  const liveResultsCollection = db.collection('liveResults');
  const finalResultsCollection = db.collection('finalResults');
  const teamsCollection = db.collection('teams');
  const fixturesCollection = db.collection('fixtures');

  let timerInterval = null;
  let timerData = null;

  function formatTime(seconds){
    const m=Math.floor(seconds/60);
    const s=seconds%60;
    return (m<10?'0':'')+m+':'+(s<10?'0':'')+s;
  }

  function calculateTimeLeft(){
    if(!timerData) return TIMER_DURATION;
    const {startTime,running,pausedAt}=timerData;
    if(!startTime) return TIMER_DURATION;
    const now = Date.now();
    if(running){
      const elapsed=(now - startTime.toMillis())/1000 + pausedAt;
      return Math.max(0,TIMER_DURATION-elapsed);
    }else{
      return Math.max(0,TIMER_DURATION-pausedAt);
    }
  }

  function startTimerDisplay(){
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      const timeLeft = calculateTimeLeft();
      timerBox().textContent = formatTime(Math.floor(timeLeft));
      if(timeLeft<=0) clearInterval(timerInterval);
    },1000);
  }

  function listenTimer(){
    timerDoc.onSnapshot(doc=>{
      timerData=doc.exists?doc.data():null;
      timerBox().textContent=formatTime(calculateTimeLeft());
      if(timerInterval) clearInterval(timerInterval);
      if(timerData && timerData.running && calculateTimeLeft()>0){
        startTimerDisplay();
      }
    });
  }

  async function startTimer(){
    const now=firebase.firestore.Timestamp.now();
    let pausedAt = timerData?.pausedAt||0;
    await timerDoc.set({startTime:now,running:true,pausedAt});
  }

  async function pauseTimer(){
    if(!timerData || !timerData.running || !timerData.startTime) return;
    if(!confirm('Are you sure you want to pause the timer?')) return;
    const now = Date.now();
    const elapsed = (now-timerData.startTime.toMillis())/1000+(timerData.pausedAt||0);
    await timerDoc.set({...timerData,running:false,pausedAt:elapsed});
  }

  async function resetTimer(){
    if(!confirm('Are you sure you want to reset the timer?')) return;
    await timerDoc.set({startTime:null,running:false,pausedAt:0});
  }

  // Authentication
  function login(){
    const email=document.getElementById('email').value.trim();
    const password=document.getElementById('password').value.trim();
    auth.signInWithEmailAndPassword(email,password)
      .catch(err=>alert('Login failed: '+err.message));
  }

  function logout(){
    auth.signOut();
  }

  async function loadCurrentMatch(){
    const doc = await currentMatchDoc.get();
    if(doc.exists){
      const data = doc.data();
      teamAInput().value=data.teamA||'';
      teamBInput().value=data.teamB||'';
      scoreAInput().value=data.scoreA!=null?data.scoreA:'';
      scoreBInput().value=data.scoreB!=null?data.scoreB:'';
    }else{
      teamAInput().value='';
      teamBInput().value='';
      scoreAInput().value='';
      scoreBInput().value='';
    }
  }

  async function saveResult(){
    const teamA = teamAInput().value.trim();
    const teamB = teamBInput().value.trim();
    const scoreA = parseInt(scoreAInput().value);
    const scoreB = parseInt(scoreBInput().value);

    if(!teamA||!teamB){alert('Enter both teams'); return;}
    if(teamA.toLowerCase()===teamB.toLowerCase()){alert('Teams must be different');return;}
    if(isNaN(scoreA)||scoreA<0||isNaN(scoreB)||scoreB<0){alert('Enter valid scores');return;}

    await liveResultsCollection.add({teamA,teamB,scoreA,scoreB,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    await currentMatchDoc.set({teamA,teamB,scoreA,scoreB,updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
    alert('Live result saved!');
  }

  async function clearCurrentMatch(){
    if(!confirm('Clear current match?')) return;
    await currentMatchDoc.delete();
    teamAInput().value='';
    teamBInput().value='';
    scoreAInput().value='';
    scoreBInput().value='';
  }

  async function endGame(){
    if(!confirm('Are you sure you want to end the game?')) return;
    const teamA = teamAInput().value.trim();
    const teamB = teamBInput().value.trim();
    const scoreA = parseInt(scoreAInput().value);
    const scoreB = parseInt(scoreBInput().value);
    if(!teamA||!teamB||isNaN(scoreA)||isNaN(scoreB)){alert('Enter valid teams and scores');return;}
    await finalResultsCollection.add({teamA,teamB,scoreA,scoreB,timestamp:firebase.firestore.FieldValue.serverTimestamp()});
    alert('Game ended!');
  }

  function listenFinalResults(){
    finalResultsCollection.orderBy('timestamp','asc').onSnapshot(snapshot=>{
      const tbody=document.getElementById('results-body');
      tbody.innerHTML='';
      let matchNum=1;
      snapshot.forEach(doc=>{
        const d=doc.data();
        const row=document.createElement('tr');
        row.innerHTML=`
          <td>${matchNum++}</td>
          <td>${d.teamA}</td>
          <td>${d.scoreA}</td>
          <td>${d.teamB}</td>
          <td>${d.scoreB}</td>
          <td><button onclick="removeFinalResult('${doc.id}')">Remove ‚ùå</button></td>
        `;
        tbody.appendChild(row);
      });
    });
  }

  async function removeFinalResult(id){
    if(!confirm('Remove this result?')) return;
    await finalResultsCollection.doc(id).delete();
  }

  function listenLatestLiveMatch(){
    liveResultsCollection.orderBy('timestamp','desc').limit(1).onSnapshot(snapshot=>{
      if(snapshot.empty){liveMatchBox().innerHTML='<h2>No live matches currently</h2>';return;}
      const d=snapshot.docs[0].data();
      liveMatchBox().innerHTML=`<h2>Live Match</h2><div class="teams">${d.teamA} vs ${d.teamB}</div><div class="score">${d.scoreA} - ${d.scoreB}</div>`;
    });
  }

  // --- Team Management ---
  async function addTeam() {
    const name = document.getElementById('new-team').value.trim();
    if (!name || name.toLowerCase() === 'team name') return alert('Enter a valid team name');

    // Prevent duplicates
    const snapshot = await teamsCollection.where('name', '==', name).get();
    if (!snapshot.empty) return alert('Team already registered');

    await teamsCollection.add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    document.getElementById('new-team').value = '';
    loadTeams();
  }

  async function loadTeams(){
  const snapshot = await teamsCollection.get();
  teamsList.innerHTML='';

  snapshot.forEach(doc=>{
    const li=document.createElement('li');
    li.textContent = doc.data().name;

    const removeBtn = document.createElement('button');
    removeBtn.textContent = 'Remove ‚ùå';
    removeBtn.onclick = async () => {
      if(!confirm(`Remove team "${doc.data().name}"?`)) return;
      await teamsCollection.doc(doc.id).delete();
      loadTeams();
    };

    li.appendChild(removeBtn);
    teamsList.appendChild(li);
  });
}

  // --- Fixture Generation ---
  async function generateFixtures() {
    const mode = matchTypeSelect.value;
    const snapshot = await teamsCollection.get();
    let teams = snapshot.docs.map(d=>d.data().name);
    teams = teams.sort(()=>0.5-Math.random());
    const teamCount = mode==='1v1'?2:mode==='2v2'?4:6;
    let fixtures=[];
    while(teams.length>=teamCount){
      fixtures.push(teams.splice(0,teamCount));
    }
    for(let match of fixtures){
      await fixturesCollection.add({teams:match,matchType:mode,status:'pending',createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    }
    alert('Fixtures generated!');
    loadFixtures();
  }

  function loadFixtures(){
    fixturesCollection.where('status','==','pending').get().then(snapshot=>{
      fixturesList.innerHTML='';
      snapshot.forEach(doc=>{
        const li=document.createElement('li');
        li.textContent=doc.data().teams.join(' vs ') + ' ';
        const btn=document.createElement('button');
        btn.textContent='Load Match';
        btn.onclick=()=>loadFixtureToEditor(doc.id, doc.data().teams);
        li.appendChild(btn);
        fixturesList.appendChild(li);
      });
    });
  }

  async function loadFixtureToEditor(id, teams){
    const [teamA, teamB] = teams;
    teamAInput().value=teamA;
    teamBInput().value=teamB;
    scoreAInput().value=0;
    scoreBInput().value=0;
    await currentMatchDoc.set({teamA,teamB,scoreA:0,scoreB:0});
    alert('Fixture loaded into match editor!');
  }

  // --- Auth State UI ---
  auth.onAuthStateChanged(user=>{
    if(user){
      userInfo().innerHTML=`Logged in as: ${user.email} <button onclick="logout()">Logout</button>`;
      loginForm().style.display='none';
      matchEditorDiv().style.display='block';
      document.getElementById('team-registration').style.display='block';
            document.getElementById('fixture-generator').style.display='block';

      teamAInput().disabled=false;
      teamBInput().disabled=false;
      scoreAInput().disabled=false;
      scoreBInput().disabled=false;

      loadCurrentMatch();
      loadTeams();
      loadFixtures();
      listenFinalResults();
      listenLatestLiveMatch();
      listenTimer();
    }else{
      userInfo().textContent='';
      loginForm().style.display='block';
      matchEditorDiv().style.display='none';
      document.getElementById('team-registration').style.display='none';
      document.getElementById('fixture-generator').style.display='none';

      teamAInput().disabled=true;
      teamBInput().disabled=true;
      scoreAInput().disabled=true;
      scoreBInput().disabled=true;
    }
  });
  async function clearFixtures() {
  if (!confirm('Are you sure you want to remove all fixtures? This cannot be undone.')) return;
  
  const snapshot = await fixturesCollection.where('status', '==', 'pending').get();
  const batch = db.batch();

  snapshot.forEach(doc => {
    batch.delete(doc.ref);
  });

  await batch.commit();
  alert('All pending fixtures removed!');
  loadFixtures(); // Refresh the list
}

</script>
<!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Extrabotics</h3>
                    <p>Pushing the boundaries of robotics innovation through cutting-edge technology and education.</p>
                    <div class="social-links">
                        <a href="contact.html" class="social-link">üìß</a>
                        <a href="contact.html" class="social-link">üì±</a>
                        <a href="contact.html" class="social-link">üîó</a>
                    </div>
                </div>
                
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="index.html">Home</a></li>
                        <li><a href="about.html">About</a></li>
                        <li><a href="events.html">Events</a></li>
                        <li><a href="gallery.html">Gallery</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Programs</h4>
                    <ul class="footer-links">
                        <li><a href="events.html">Robotics Competitions</a></li>
                        <li><a href="events.html">Educational Workshops</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Contact</h4>
                    <div class="contact-info">
                        <p>Ruaraka, Outering Road</p>
                        <p>+254 706 781 886</p>
                        <p>info@extrabotics.com</p>
                        <p>competitions@extrabotics.com</p>
                        <p>proposals@extrabotics.com</p>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 Extrabotics. All rights reserved. | Designed for innovation and excellence.</p>
            </div>
        </div>
    </footer>

</body>
</html>

